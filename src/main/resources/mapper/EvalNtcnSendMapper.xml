<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.visang.aidt.lms.api.assessment.mapper.EvalNtcnSendMapper">

    <select id="findEvalSendNtcnUnsubEndListToTch" resultType="camelHashMap">
        /** EvalNtcnSendMapper.findEvalSendNtcnUnsubEndListToTch */
        select
            textbook_id as textbk_id
             , "T" as trget_cd
             , "3" as ntcn_ty_cd
             , "10" as trget_ty_cd
             , a.id as trget_id
             , (CASE when stut_cnt > 0 then CONCAT(evl_nm, " 마감일이 ", #{diffDay}, "일 남았습니다. (미제출 학생 : ", stut_cnt, "명)")
                     else CONCAT(evl_nm, " 마감일이 ", #{diffDay}, "일 남았습니다. (미제출 학생 : 없음)")
                END) as ntcn_cn
             , '' as link_url
             , flnm as stnt_nm
             , wrter_id as user_id
             , sets_id
             , cla_id
        from
            (
                select
                    textbook_id
                     , cla_id
                     , wrter_id
                     , evl_nm
                     , um.flnm
                     , b.stud_list
                     , b.stut_cnt
                     , sets_id
                     , a.id
                from aidt_lms.evl_info a
                         left join aidt_lms.user um ON um.user_id = a.wrter_id
                         left join (select evl_id
                                         , count(*) stut_cnt
                                         , GROUP_CONCAT(distinct mamoym_id order by mamoym_id SEPARATOR ',') as stud_list
                                    from aidt_lms.evl_result_info where eak_at = 'N' group by evl_id) b on a.id = b.evl_id
                where evl_stts_cd in (1,2)
                  and DATE_FORMAT(pd_evl_ed_dt, "%Y-%m-%d") = (CURDATE()+INTERVAL #{diffDay} DAY)
                  and a.id = b.evl_id
            ) a
    </select>

    <select id="findEvalSendNtcnUnsubEndListToStnt" resultType="camelHashMap">
        /** EvalNtcnSendMapper.findEvalSendNtcnUnsubEndListToStnt */
        select
            mamoym_id as rcve_id
             , textbook_id as textbk_id
             , "S" as trget_cd
             , "3" as ntcn_ty_cd
             , "10" as trget_ty_cd
             , a.evl_id as trget_id
             ,  CONCAT(evl_nm, " 마감일이 ", #{diffDay}, "일 남았습니다.") as ntcn_cn
             , '' as link_url
             , flnm as stnt_nm
             , wrter_id as user_id
             , sets_id
             , cla_id
        from
            (
                select
                    b.evl_nm
                     , b.textbook_id
                     , b.cla_id
                     , b.wrter_id
                     , a.sets_id
                     , a.mamoym_id
                     , um.flnm
                     , a.evl_id
                from aidt_lms.evl_result_info a
                         left join aidt_lms.user um ON um.user_id = a.mamoym_id
                         left join aidt_lms.evl_info b on b.id = a.evl_id
                where
                    a.evl_id in (select id
                                 from aidt_lms.evl_info
                                 where evl_stts_cd in (1,2)
                                   and DATE_FORMAT(pd_evl_ed_dt, "%Y-%m-%d") = (CURDATE()+INTERVAL #{diffDay} DAY))
                  and a.eak_at = 'N'
            ) a
    </select>

    <select id="findEvalSendNtcnUnsubStListToTch" resultType="camelHashMap">
        /** EvalNtcnSendMapper.findEvalSendNtcnUnsubStListToTch */
        select
            textbook_id as textbk_id
             , "T" as trget_cd
             , "3" as ntcn_ty_cd
             , "10" as trget_ty_cd
             , a.id as trget_id
             ,  CONCAT(evl_nm, " 시작일이 ", #{diffDay}, "일 남았습니다.") as ntcn_cn
             , '' as link_url
             , flnm as stnt_nm
             , wrter_id as user_id
             , sets_id
             , cla_id
        from
            (
                select
                    textbook_id
                     , cla_id
                     , wrter_id
                     , evl_nm
                     , um.flnm
                     , b.stud_list
                     , b.stut_cnt
                     , sets_id
                     , a.id
                from aidt_lms.evl_info a
                         left join aidt_lms.user um ON um.user_id = a.wrter_id
                         left join (select evl_id
                                         , count(*) stut_cnt
                                         , GROUP_CONCAT(distinct mamoym_id order by mamoym_id SEPARATOR ',') as stud_list
                                    from aidt_lms.evl_result_info where eak_at = 'N' group by evl_id) b on a.id = b.evl_id
                where evl_stts_cd in (1,2)
                  and DATE_FORMAT(pd_evl_st_dt, "%Y-%m-%d") = (CURDATE()+INTERVAL #{diffDay} DAY)
                  and a.id = b.evl_id
            ) a
    </select>

    <select id="findEvalSendNtcnUnsubStListToStnt" resultType="camelHashMap">
        /** EvalNtcnSendMapper.findEvalSendNtcnUnsubStListToStnt */
        select
            mamoym_id as rcve_id
             , textbook_id as textbk_id
             , "S" as trget_cd
             , "3" as ntcn_ty_cd
             , "10" as trget_ty_cd
             , a.evl_id as trget_id
             ,  CONCAT(evl_nm, " 시작일이 ", #{diffDay}, "일 남았습니다.") as ntcn_cn
             , '' as link_url
             , flnm as stnt_nm
             , wrter_id as user_id
             , sets_id
             , cla_id
        from
            (
                select
                    b.evl_nm
                     , b.textbook_id
                     , b.cla_id
                     , b.wrter_id
                     , a.sets_id
                     , a.mamoym_id
                     , um.flnm
                     , a.evl_id
                from aidt_lms.evl_result_info a
                         left join aidt_lms.user um ON um.user_id = a.mamoym_id
                         left join aidt_lms.evl_info b on b.id = a.evl_id
                where
                    a.evl_id in (select id
                                 from aidt_lms.evl_info
                                 where evl_stts_cd in (1,2)
                                   and DATE_FORMAT(pd_evl_st_dt, "%Y-%m-%d") = (CURDATE()+INTERVAL #{diffDay} DAY))
                  and a.eak_at = 'N'
            ) a
    </select>

    <insert id="insertEvalCreateReportListSendNtcnToTch" parameterType="map">
        /** EvalNtcnSendMapper.insertEvalCreateReportListSendNtcnToTch */
        INSERT INTO aidt_lms.ntcn_info
        SELECT
            null as id
            , a.textbk_id
            , a.cla_id
            , a.trget_cd
            , a.ntcn_ty_cd
            , a.trget_ty_cd
            , a.trget_id
            , a.rcve_id
            , a.ntcn_cn
            , 'N' as ntcn_idnty_at
            , 'N' as redng_at
            , a.link_url
            , 'N' as encrg_at
            , a.stnt_nm
            , a.user_id as rgtr
            , now()
            , a.user_id as mdfr
            , now()
        FROM
        (
        SELECT
            ei.wrter_id as rcve_id
            , ei.textbook_id as textbk_id
            , ei.cla_id
            , ei.id as trget_id
            , "T" as trget_cd
            , "3" as ntcn_ty_cd
            , "7" as trget_ty_cd
            ,  CONCAT("리포트가 생성되었습니다. 평가 리포트를 확인해 보세요.") as ntcn_cn
            , '' as link_url
            , "" as stnt_nm
            , ei.wrter_id as user_id
            , ei.sets_id
        FROM aidt_lms.evl_info ei
        <if test="brandIdList != null and brandIdList != '' ">
            inner join aidt_lcms.textbook tb /* 해당 과목의 교과서만 대상 */
            on ei.textbook_id = tb.id
            and tb.brand_id in (<foreach item="item" collection="brandIdList" separator=",">#{item}</foreach>)
        </if>
        WHERE 1=1
            AND ei.evl_stts_cd >= 3   /* 평가상태 = 3 인경우 */
            AND not exists (
                select 1
                from aidt_lms.evl_result_info eri
                where eri.evl_id = ei.id
                    and eri.eak_stts_cd <![CDATA[<]]> 3
            ) /* 모든 학생이 완료된 건만 조회, 해당 평가에 속한 학생들의 응시상태가 모두 3 이상인 경우 조건 */
            AND 0 = (
                select count(1) from aidt_lms.ntcn_info
                where 1=1
                    and trget_cd = 'T'
                    and ntcn_ty_cd = '3'
                    and trget_ty_cd = '7'
                    and trget_id = ei.id
            ) /* 미등록 건만 처리 */
        ) a
    </insert>

    <insert id="insertEvalCreateReportListSendNtcnToTch_new" parameterType="map">
            /** EvalNtcnSendMapper.insertEvalCreateReportListSendNtcnToTch_new */
            INSERT INTO aidt_lms.ntcn_info
            SELECT
                null as id
                , a.textbk_id
                , a.cla_id
                , a.trget_cd
                , a.ntcn_ty_cd
                , a.trget_ty_cd
                , a.trget_id
                , a.rcve_id
                , a.ntcn_cn
                , 'N' as ntcn_idnty_at
                , 'N' as redng_at
                , a.link_url
                , 'N' as encrg_at
                , a.stnt_nm
                , a.user_id as rgtr
                , now()
                , a.user_id as mdfr
                , now()
            FROM
            (
                SELECT
                      ei.wrter_id as rcve_id
                    , ei.textbook_id as textbk_id
                    , ei.cla_id
                    , ei.id as trget_id
                    , "T" as trget_cd
                    , "3" as ntcn_ty_cd
                    , "7" as trget_ty_cd
                    ,  CONCAT("리포트가 생성되었습니다. 평가 리포트를 확인해 보세요.") as ntcn_cn
                    , '' as link_url
                    , "" as stnt_nm
                    , ei.wrter_id as user_id
                    , ei.sets_id
                FROM aidt_lms.evl_info ei
                <if test="brandIdList != null and brandIdList != '' ">
                    inner join aidt_lcms.textbook tb /* 해당 과목의 교과서만 대상 */
                        on ei.textbook_id = tb.id
                            and tb.brand_id in (<foreach item="item" collection="brandIdList" separator=",">#{item}</foreach>)
                </if>
                WHERE 1=1
                    AND ei.evl_stts_cd >= 2 /* 학생이 제출하자마자 리포트 생성 알림이 가야하므로 */
                    AND exists (
                        select 1
                        from aidt_lms.evl_result_info eri2
                        where eri2.evl_id = ei.id
                            and eri2.subm_at = 'Y'
                    )  /* subm_at = 'Y' 조건 추가 */
                    AND (ei.rpt_othbc_at = 'Y' OR ei.rpt_auto_othbc_at = 'Y')  /* 자동 공유 여부 혹은 수동 공유 여부 값이 Y인 조건 추가 */
                    AND not exists (
                        select 1
                        from aidt_lms.evl_result_info eri
                        where eri.evl_id = ei.id
                            and eri.eak_stts_cd <![CDATA[<]]> 2   /* 예정일 경우 제외 */
                    )
                    AND 0 = (
                        select count(1) from aidt_lms.ntcn_info
                        where 1=1
                            and trget_cd = 'T'
                            and ntcn_ty_cd = '3'
                            and trget_ty_cd = '7'
                            and trget_id = ei.id
                    ) /* 미등록 건만 처리 */
            ) a
        </insert>
</mapper>

