<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.visang.aidt.lms.api.mq.mapper.bulk.AssignmentFinishedMapper">

    <insert id="insertAssignmentSubmissionInfo" parameterType="com.visang.aidt.lms.api.mq.dto.assignment.AssignmentFinishedSaveDto">
    /*insertAssignmentSubmissionInfo*/
        INSERT INTO aidt_lms.bulk_task_mq_trn_log (
            `task_gb_cd`,
            `task_id`,
            `task_reg_dt`,
            `stnt_id`,
            `rgtr`,
            `cla_id`
        )
        SELECT
            #{taskGbCd},    /* task_gb_cd 값 */
            ti.id,          /* task_id 값 */
            ti.reg_dt,      /* task_reg_dt 값 */
            tcmb.stdt_id,   /* stnt_id 값 */
            ti.wrter_id,    /* rgtr 값 */
            tcmb.cla_id     /* cla_id 값 */
        FROM aidt_lms.task_info ti
                 INNER JOIN aidt_lms.tc_cla_mb_info tcmb
                            ON ti.cla_id = tcmb.cla_id
        WHERE ti.id = #{taskId}
          and tcmb.stdt_id = #{stntId}
          and tcmb.actvtn_at = 'Y'
    </insert>


    <select id="findAssignmentSubmissionInfo" parameterType="com.visang.aidt.lms.api.mq.dto.real.RealMqReqDto" resultType="com.visang.aidt.lms.api.mq.dto.assignment.AssignmentFinishedInfoDto">
    /*findAssignmentSubmissionInfo*/
    SELECT
        stnt_id as stntId,
        task_id as taskId,
        task_reg_dt as taskRegDt,
        subm_dt as submDt,
        GROUP_CONCAT(DISTINCT standardId ORDER BY standardId) AS standardIds
    FROM (
             SELECT
                 a.sets_id,
                 a.stnt_id,
                 a.task_id,
                 a.task_reg_dt,
                 a.subm_dt,
                 SUBSTRING_INDEX (SUBSTRING_INDEX(a.val1,',',numbers.n),',',-1) as standardId
             from
                 (
                     WITH RECURSIVE cte AS (
                         SELECT 1 AS n
                         UNION ALL
                         SELECT n + 1 FROM cte WHERE n <![CDATA[<]]> 10
                     )
                     select n from cte
                 ) numbers
                     INNER JOIN (
                     select
                         distinct
                         bulk.task_id,
                         ti.sets_id,
                         bulk.task_reg_dt,
                         bulk.stnt_id,
                         ifnull(replace(d.val1,'#^|',','), -1) as val1,
                         tri.subm_dt
                     from
                         aidt_lms.bulk_task_mq_trn_log bulk
                             inner join aidt_lms.task_info ti
                                        on bulk.task_id = ti.id
                             inner join aidt_lms.task_result_info tri
                                        on ti.id = tri.task_id
                                               and bulk.stnt_id = tri.mamoym_id
                                               and tri.eak_stts_cd >= 3
                             left join aidt_lcms.setsummary a
                                        on ti.sets_id = a.set_id
                             left join aidt_lcms.article_meta_map b
                                        on a.article_id = b.article_id
                                            and a.sub_id = b.sub_id
                                            and b.meta_name = 'studyMap_1' /* 지식요인 */
                             left join aidt_lcms.meta c
                                        on b.meta_id = c.id
                             left join aidt_lcms.meta_extension d
                                        on c.meta_extension_id = d.meta_extension_id
                     where 1=1
                       and bulk.task_gb_cd = '2' /*과제 제출*/
                       and bulk.trn_at = 'N' /* 전송여부 */
                       <if test="userId != null and userId != ''">
                            and bulk.stnt_id = #{userId}
                       </if>
                     order by bulk.stnt_id
                 ) a
                                ON CHAR_LENGTH(a.val1) - CHAR_LENGTH(REPLACE(a.val1,',','')) <![CDATA[>=]]> numbers.n-1
             where 1=1
               <if test="startTime != null and startTime != ''">
                    and a.task_reg_dt <![CDATA[>=]]> #{startTime}
               </if>
               <if test="endTime != null and endTime != ''">
                    and a.task_reg_dt <![CDATA[<]]> #{endTime}
               </if>
         ) AS subquery
    GROUP BY sets_id, stnt_id, task_id, task_reg_dt
    ORDER BY sets_id, stnt_id, task_id, task_reg_dt
    </select>

    <update id="updateAssignmentFinishedSendAt">
        /*updateAssignmentFinishedSendAt*/
        UPDATE aidt_lms.bulk_task_mq_trn_log
        SET trn_at = 'Y'
          , mdfy_dt = now()
        WHERE trn_at = 'N'
          AND task_gb_cd = 2 /*과제 제출*/
    </update>

    <select id="getUserInfo" resultType="camelHashMap" parameterType="String">
        SELECT
            COALESCE(ptn_id, '') AS ptn_id,
            IFNULL(NULLIF(use_terms_agree_yn, ''), 'N') AS use_terms_agree_yn
        FROM aidt_lms.user
        WHERE user_id = #{userId}
    </select>
</mapper>