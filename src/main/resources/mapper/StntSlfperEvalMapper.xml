<?xml version="1.0" encoding="UTF-8" ?>
<!-- mapper DTD 선언 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.visang.aidt.lms.api.assessment.mapper.StntSlfperEvalMapper">

    <select id="findStntSlfperEvlSlfSet" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSet */
        select *
          from aidt_lms.slf_per_evl_set_info si
         where si.gb_cd = #{gbCd}
           and si.slf_per_evl_clsf_cd = #{slfPerEvlSetInfo}
           /* and module_subm_at = # {moduleSubmAt} */
        <choose>
            <when test="gbCd == 1 ">
                <if test="textbkId != null and textbkId != '' ">
                    AND si.textbk_id = #{textbkId}
                </if>
                <if test="tabId != null and tabId != '' ">
                    AND si.tab_id = #{tabId}
                </if>
                <if test="moduleId != null and moduleId != '' ">
                    AND si.module_id = #{moduleId}
                </if>
                <if test="subId != null and subId != '' ">
                    AND si.sub_id = #{subId}
                </if>
            </when>
            <when test="gbCd == 2 ">
                <if test="taskId != null and taskId != '' ">
                    AND si.task_id = #{taskId}
                </if>
            </when>
            <when test="gbCd == 3 ">
                <if test="evlId != null and evlId != '' ">
                    AND si.evl_id = #{evlId}
                </if>
            </when>
        </choose>
        <choose>
            <when test="setsId != null and setsId != '' ">
                AND si.sets_id = #{setsId}
            </when>
            <otherwise>
                AND si.sets_id is null
            </otherwise>
        </choose>
        limit 1
    </select>

    <select id="findStntSlfperEvlSlfSetSlList" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSetSlList */
        select
        sdi.id as slfPerEvlDetailId
        ,sdi.slf_per_evl_set_id as selInfoId
        ,sdi.tmplt_itm_seq
        ,sdi.evl_dmi
        ,sdi.evl_iem
        ,sdi.evl_stdr_cd
        ,sdi.evl_stdr_dc
        from aidt_lms.slf_per_evl_set_detail_info sdi
        where sdi.slf_per_evl_set_id = #{selInfoId}
        order by sdi.tmplt_itm_seq
    </select>

    <!-- 사용하지 않음 -->
    <select id="findStntSlfperEvlSlfSetPerInfoList" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSetPerInfoList */
        <choose>
            <when test="gbCd == 1 ">
                select
                   ri.mamoym_id  as apraserId
                 , u.flnm
                from aidt_lms.std_dta_result_info ri
                left outer join aidt_lms.user u on u.user_id = ri.mamoym_id
                where ri.sets_id = #{setsId}
                and ri.mamoym_id <![CDATA[<>]]> #{stntId}
            </when>
            <when test="gbCd == 2 ">
                select
                   ri.mamoym_id  as apraserId
                 , u.flnm
                from aidt_lms.task_result_info ri
                left outer join aidt_lms.user u on u.user_id = ri.mamoym_id
                where task_id = #{taskId}
                and mamoym_id <![CDATA[<>]]> #{stntId}

            </when>
            <when test="gbCd == 3 ">
                select
                   ri.mamoym_id  as apraserId
                 , u.flnm
                from aidt_lms.evl_result_info ri
                left outer join aidt_lms.user u on u.user_id = ri.mamoym_id
                where evl_id = #{evlId}
                and mamoym_id <![CDATA[<>]]> #{stntId}
            </when>
        </choose>
    </select>

    <select id="findStntSlfperEvlSlfSetTempltList" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSetTempltList */
        select
        sdi.id as slfPerEvlDetailId
        ,sdi.slf_per_evl_set_id as selInfoId
        ,sdi.tmplt_itm_seq
        ,sdi.evl_dmi
        ,sdi.evl_iem
        ,sdi.evl_stdr_cd
        ,sdi.evl_stdr_dc
        from aidt_lms.slf_per_evl_set_detail_info sdi
        where sdi.slf_per_evl_set_id = #{perInfoId}
        order by sdi.tmplt_itm_seq
    </select>


    <insert id="createEvlSetSave" parameterType="map" useGeneratedKeys="true" keyProperty="id">
        /* StntSlfperEvalMapper.createEvlSetSave */
        insert into aidt_lms.slf_per_evl_set_info
        (gb_cd, wrter_id, wrt_dt, slf_per_evl_clsf_cd, slf_per_evl_nm, st_expos_at, textbk_id, tab_id, task_id, evl_id, sets_id, result_dtl_id, module_id, sub_id, rgtr, mdfr
        ,module_subm_at
        ) values (
        #{gbCd}, #{wrterId}, now(), #{slfPerEvlClsfCd}, #{slfPerEvlNm},
        <choose>
            <when test="slfPerEvlClsfCd == 1 ">
                #{slfStExposAt},
            </when>
            <when test="slfPerEvlClsfCd == 2 ">
                #{perStExposAt},
            </when>
        </choose>
        IFNULL(#{textbkId},0), IFNULL(#{tabId},0), IFNULL(#{taskId},0), IFNULL(#{evlId},0), #{setsId}, #{resultDtlId}, #{moduleId}, #{subId}, 'system', 'system'
        ,#{moduleSubmAt}
        )
    </insert>

    <insert id="createSetDetailInfo" parameterType="map" useGeneratedKeys="true">
        /* StntSlfperEvalMapper.createSetDetailInfo */
        insert into aidt_lms.slf_per_evl_set_detail_info
        (slf_per_evl_set_id, tmplt_itm_seq, evl_dmi, evl_iem, evl_stdr_cd, evl_stdr_dc, rgtr, mdfr
        ) values (
        #{setId}, #{tmpltItmSeq}, #{evlDmi}, #{evlIem}, #{evlStdrCd}, #{evlstdrDc}, 'system', 'system'
        )
    </insert>

    <insert id="createEvlSlfSave" parameterType="map" useGeneratedKeys="true" keyProperty="id">
        /* StntSlfperEvalMapper.createEvlSlfSave */
        insert into aidt_lms.slf_per_evl_result_info
        (slf_per_evl_detail_id, apraser_id, evl_asw, rgtr, mdfr, per_apraser_id
        ) values (
        #{slfPerEvlDetailId}, #{apraserId}, #{evlAsw}, 'system', 'system' , #{perApraserId}
        )
    </insert>

    <select id="findEvlSetInfo" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findEvlSetInfo */
        select *
          from aidt_lms.slf_per_evl_set_info
         where id = #{selInfoId}
    </select>

    <update id="modifyEvlSlfSaveTRI" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlSlfSaveTRI */
        update aidt_lms.task_result_info
           set slf_subm_at ='Y'
             , slf_per_subm_at ='Y'
             /*, mdfr */
             , mdfy_dt = NOW()
         where mamoym_id = #{apraserId}
           and task_id = #{taskId}
    </update>

    <update id="modifyEvlSlfSaveSetInfoTask" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlSlfSaveSetInfoTask */
        update aidt_lms.slf_per_evl_set_info
           set result_dtl_id = (select id
                                  from aidt_lms.task_result_info
                                 where mamoym_id = #{apraserId}
                                   and task_id = #{taskId}
                                )
              /*, mdfr */
              , mdfy_dt = NOW()
         where id = #{selInfoId}
    </update>

    <update id="modifyEvlSlfSaveERI" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlSlfSaveERI */
        update aidt_lms.evl_result_info
           set slf_subm_at ='Y'
             , slf_per_subm_at ='Y'
             /*, mdfr */
             , mdfy_dt = NOW()
         where mamoym_id = #{apraserId}
           and evl_id = #{evlId}
    </update>

    <update id="modifyEvlSlfSaveSetInfoEvl" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlSlfSaveSetInfoEvl */
        update aidt_lms.slf_per_evl_set_info
           set result_dtl_id = (select id
                                  from aidt_lms.evl_result_info
                                 where mamoym_id = #{apraserId}
                                   and evl_id = #{evlId}
                                )
           /*, mdfr */
           , mdfy_dt = NOW()
         where id = #{selInfoId}
    </update>

    <update id="modifyEvlSlfSaveSetInfo" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlSlfSaveSetInfo */
        update aidt_lms.slf_per_evl_set_info
           set module_subm_at = 'Y'
           /*, mdfr */
           , mdfy_dt = NOW()
         where id = #{selInfoId}
    </update>

    <update id="modifyEvlPerSaveTRI" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlPerSaveTRI */
        update aidt_lms.task_result_info
           set per_subm_at ='Y'
             , slf_per_subm_at ='Y'
             /*, mdfr */
             , mdfy_dt = NOW()
         where mamoym_id = #{apraserId}
           and task_id = #{taskId}
    </update>

    <update id="modifyEvlPerSaveSetInfoTask" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlPerSaveSetInfoTask */
        update aidt_lms.slf_per_evl_set_info
           set result_dtl_id = (select id
                                  from aidt_lms.task_result_info
                                 where mamoym_id = #{apraserId}
                                   and task_id = #{taskId}
                                )
           /*, mdfr */
           , mdfy_dt = NOW()
          where id = #{perInfoId}
    </update>

    <update id="modifyEvlPerSaveERI" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlPerSaveERI */
        update aidt_lms.evl_result_info
           set per_subm_at ='Y'
             , slf_per_subm_at ='Y'
             /*, mdfr */
             , mdfy_dt = NOW()
         where mamoym_id = #{apraserId}
           and evl_id = #{evlId}
    </update>

    <update id="modifyEvlPerSaveSetInfoEvl" parameterType="map">
        /* StntSlfperEvalMapper.modifyEvlPerSaveSetInfoEvl */
        update aidt_lms.slf_per_evl_set_info
           set result_dtl_id = (select id
                                  from aidt_lms.evl_result_info
                                 where mamoym_id = #{apraserId}
                                   and evl_id = #{evlId}
                                )
             /*, mdfr */
             , mdfy_dt = NOW()
          where id = #{perInfoId}
    </update>

    <select id="findStntSlfperEvlSlfSetSlfperYn" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSetSlfperYn */
        select case esi.gb_cd
               when 1
                   then (esi.module_subm_at)
               when 2
                    then (select tri.slf_subm_at from aidt_lms.task_result_info tri where tri.id = esi.result_dtl_id)
               when 3
                    then (select eri.slf_subm_at from aidt_lms.evl_result_info eri where eri.id = esi.result_dtl_id)
               else if(esi.module_id is not null, esi.module_subm_at, null) end as slfperYn
        from aidt_lms.slf_per_evl_set_info esi
        where id = #{selInfoId}
        and exists(select apraser_id from aidt_lms.slf_per_evl_result_info where slf_per_evl_detail_id
        in (
        		select t2.id
        		from aidt_lms.slf_per_evl_set_info t1
        		join aidt_lms.slf_per_evl_set_detail_info t2 on t1.id = t2.slf_per_evl_set_id
        		where t1.id = #{selInfoId}
        		)
        		 and apraser_id = #{stntId}
         )

    </select>

    <select id="findStntSlfperEvlSlfSetTempltYn" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfSetTempltYn */
        select case esi.gb_cd
               when 1
                   then (esi.module_subm_at)
               when 2
                    then (select tri.slf_subm_at from aidt_lms.task_result_info tri where tri.id = esi.result_dtl_id)
               when 3
                    then (select eri.slf_subm_at from aidt_lms.evl_result_info eri where eri.id = esi.result_dtl_id)
               else if(esi.module_id is not null, esi.module_subm_at, null) end as slfperYn
        from aidt_lms.slf_per_evl_set_info esi
        where id = #{perInfoId}
        and exists(select apraser_id from aidt_lms.slf_per_evl_result_info where slf_per_evl_detail_id
        in (
        		select t2.id
        		from aidt_lms.slf_per_evl_set_info t1
        		join aidt_lms.slf_per_evl_set_detail_info t2 on t1.id = t2.slf_per_evl_set_id
        		where t1.id = #{perInfoId}
        		)
        		 and apraser_id = #{stntId}
         )
    </select>

    <select id="findStntSlfperEvlSlfPerinfo" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlSlfPerinfo */
        select u.user_id as perApraserId, u.flnm from
        aidt_lms.tc_cla_mb_info tcmi
        left join user u on u.user_id = tcmi.stdt_id
        where tcmi.cla_id = #{claId}
          AND tcmi.stdt_id <![CDATA[<>]]> #{stntId}
          and tcmi.actvtn_at = 'Y'
    </select>

    <select id="findEvlSetSave" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findEvlSetSave */
        select * from
        aidt_lms.slf_per_evl_set_info si
        where 1=1
        and si.gb_cd = #{gbCd}
        <choose>
            <when test="gbCd == 1 ">
                <if test="textbkId != null and textbkId != '' ">
                    AND si.textbk_id = #{textbkId}
                </if>
                <if test="tabId != null and tabId != '' ">
                    AND si.tab_id = #{tabId}
                </if>
            </when>
            <when test="gbCd == 2 ">
                <if test="taskId != null and taskId != '' ">
                    AND si.task_id = #{taskId}
                </if>
            </when>
            <when test="gbCd == 3 ">
                <if test="evlId != null and evlId != '' ">
                    AND si.evl_id = #{evlId}
                </if>
            </when>
        </choose>
        <choose>
            <when test="setsId != null and setsId != '' ">
                AND si.sets_id = #{setsId}
            </when>
            <otherwise>
                AND si.sets_id is null
            </otherwise>
        </choose>
        <choose>
            <when test="moduleId != null and moduleId != '' ">
                AND si.module_id = #{moduleId}
            </when>
            <otherwise>
                AND si.module_id is null
            </otherwise>
        </choose>
        <if test="subId != null and subId != '' ">
            AND si.sub_id = #{subId}
        </if>
        limit 1
    </select>

    <select id="findStntSlfperEvlResultDetailList" parameterType="map" resultType="camelHashMap">
        /* StntSlfperEvalMapper.findStntSlfperEvlResultDetailList */
        select tcmi.stdt_id as stntId
        , u.flnm
        , spesi.slf_per_evl_clsf_cd
        , if(count(if(speri.evl_asw is not null, 1, null)) > 0, 'Y', 'N') as evlAswAt
        from aidt_lms.tc_cla_mb_info tcmi
        left join aidt_lms.user u on u.user_id = tcmi.stdt_id
        left join aidt_lms.slf_per_evl_set_info spesi on spesi.wrter_id = tcmi.user_id
        left join aidt_lms.slf_per_evl_set_detail_info spesdi on spesdi.slf_per_evl_set_id = spesi.id
        left join aidt_lms.slf_per_evl_result_info speri on speri.slf_per_evl_detail_id  = spesdi.id and speri.apraser_id = tcmi.stdt_id
        where tcmi.cla_id = #{claId}
        and tcmi.stdt_id = #{stntId}
        and spesi.gb_cd = #{gbCd}
        <choose>
            <when test="gbCd == 1 ">
                and spesi.textbk_id = #{textbkId}
                and spesi.tab_id = #{tabId}
                and spesi.sets_id = #{setsId}
            </when>
            <when test="gbCd == 2 ">
                and spesi.task_id = #{taskId}
            </when>
            <when test="gbCd == 3 ">
                and spesi.evl_id = #{evlId}
            </when>
        </choose>
        and tcmi.actvtn_at = 'Y'
        group by tcmi.stdt_id, spesi.slf_per_evl_clsf_cd
        order by u.flnm, tcmi.stdt_id, spesi.slf_per_evl_clsf_cd
    </select>

</mapper>